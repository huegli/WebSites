+++
Description = ""
Tags = ["RPIZero", "RPI3", "Docker", "HypriotOS", "DNS", "BIND"]
date = "2016-10-30T21:05:18-07:00"
title = "Setting up Nameservers Part 4 - Advertising the servers"
+++

Setting up local nameservers is all fine and good, but rather pointless
unless the clients in the local network actually use them. Advertising
the servers I set up in
[Part 1](/2016/10/05/nameserver/ "Setting up Nameservers"),
[Part 2](/2016/10/14/nameserver2/ "Setting up Nameservers Part 2") and
[Part 3](/2016/10/16/nameserver3/ "Setting up Nameservers Part 3") is
in principle rather straightforward but there are a few wrinkles in
my local network that make it worth documenting in more detail.

For all the clients that are connected via the Wireless
D-Link 880L Router, advertising the nameservers is done on one of the 
Internet configuration web pages for the router: 

![Configuration of Nameservers in D-Link Router](/images/wifi_dns_cfg.jpg)

However, as I explained in
[setting up Nameservers Part 1](/2016/10/05/nameserver/ "Setting up Nameservers, Part 1"),
this only works if the nameservers are *outside* the subnet that the 
wireless router sets up. So in this case, with the wireless router
subnet being `192.168.0.0/24`, having nameservers at `192.168.1.77` 
(Primary nameserver) and `192.168.1.79` (Secondary nameserver) works
fine but my Docker Raspberry at `192.168.0.100` can not be advertised 
this way as a nameserver.

Furthermore, there appears to be another oddity / bug in the way the 
DIR 880L advertises the nameservers to it's clients. Looking at the
`resolv.conf` file that a client generates based on DHCP information
from the DHCP server (the wireless router in this case), I see the
following:

```
# Generated by resolvconf
domain home.nikolaischlegel.com
nameserver 192.168.1.77
nameserver 192.168.1.79
nameserver 192.168.1.254
```

Not only does the DHCP server provide the correct primary and secondary
nameservers, it *additionally* provides it's own default router (my
AT&T DSL Modem in this case) as an upstream nameserver.

This by itself wouldn't be a problem if all clients go through the list
of nameservers in priority order, as the chance of the first 2 nameservers
both being offline are rather slim. But at least my Windows 7 based work
laptop appears to pick nameservers in a somewhat randomized fashion.
It took me a while to get to the bottom of this, but as this
screenshot of the Windows 
[DNSQuerySniffer tool](http://www.nirsoft.net/utils/dns_query_sniffer.html "DNSQuerySniffer")
shows, sometimes Windows picks up the last nameserver is the list. As 
this nameserver does not know about my local host names and I have no
way of overriding that nameserver setting at the DSL Router level, 
every once in a while I get pointed to the public IP of
`nikolaischlegel.com` rather than one of the hosts in my local subnet
that I defined in my primary and secondary nameserver.

![DNSQuerySniffer Output](/images/DNSQuerySniffer.jpg)

I haven't really found a good way to address this, one possibility
would be to replace the router firmware completely with something
open source (for example [DD-WRT](http://www.dd-wrt.com/site/support/router-database "DD-WRT Project) ),
however this seems to be a rather radical solution to the problem.

Another loose end is with some of the clients in my local network.
Since I have my Docker Raspberry also set up as an (unadvertised)
nameserver, I want to at least use it locally for the docker containers
running on it. The way to do this is to prepend a nameserver
from the list that the Docker Raspberry receives from the DHCP server.
This can be done by modifying the `dhclient.conf` file as follows:

**/etc/dhcp/dhclient.conf**
```
# Configuration file for /sbin/dhclient, which is included in Debian's
#       dhcp3-client package.
... lot's of commented out stuff ...
#

interface "eth0" {
    prepend domain-name-servers 192.168.0.100;
}
```

This will ensure that the Docker Raspberry (at `192.168.0.100`) is 
listed in `resolv.conf` before the DHCP Server provided nameservers.

Another client to take care of is the Raspberry running my
primary nameserver, which, as explained above, sits *outside* of the
subset that the wireless router provides. Interestingly, this
Raspberry (which still runs 
[Raspbian](https://www.raspbian.org/ "Raspbian") as opposed to
[HypriotOS](http://blog.hypriot.com/downloads/ "HypriotOS) ) uses
a different DHCP client (`dhcpcd`), so the configuration file for
it is different although the principle of overriding DHCP-provided
nameservers is the same (in this case, the DHCP Server is my
AT&T DSL Router and it would give out AT&T nameservers that of
course don't know about my local network DNS entries):

**/etc/dhcpcd.conf**
```
# A sample configuration for dhcpcd.
# See dhcpcd.conf(5) for details.
... default configuration ...

# Provide my own nameservers
static domain_name_servers=192.168.1.77 192.168.1.79
```
